window.addEventListener("load",function(){var a=document.createElement("div");a.className="traquer-recorder";a.id="traquer-recorder";a.title="Record";controls=new Controls;controls.loadStyles();a.addEventListener("click",controls.recording.bind(this,controls));document.body.appendChild(a)});"use strict";var Controls=function(){if(!(this instanceof Controls))return new Controls;this.traquer=new Traquer;this.styles=["base.css","timeline.css","recorder.css","player.css","reset.css"]};
Controls.prototype.loadStyles=function(){var a=document.head.querySelectorAll("link"),b=!1,c;for(c in a)a.hasOwnProperty(c)&&-1<this.styles.indexOf(a[c].href)&&(b=!0);b||(a=document.createElement("link"),a.rel="stylesheet",a.type="text/css",a.href="http://localhost:3008/traquer.min.css",document.head.appendChild(a))};
Controls.prototype.recording=function(a,b){var c=a.traquer,d=b.target,e=document.querySelector(".player");c.isRecording?(e&&document.body.removeChild(e),e=new Lzw,d.className="traquer-recorder",c.stop(),c=e.encode(c.recordedEvents),d=e.decode(c),a.recordedEvents=d,console.log(e.getHumanReadableLength(c)),a.timeline.call(a),a.player.call(a)):(c.start(),d.className="traquer-recorder squared")};
Controls.prototype.timeline=function(){var a=this.traquer,b=a.recordedEvents,c=document.querySelector("ol.timeline-container");c||(c=document.createElement("ol"),c.className="timeline-container",document.body.appendChild(c));c.innerHTML="";var d=c.getBoundingClientRect().width,e=b[b.length-1].time;this.tlcWidth=d;var f=2147E6,g=[],n="",l,p;for(p in b)if(b.hasOwnProperty(p)){var k=b[p],h=parseInt(100*(k.time/e)),h=parseInt(h*d/100),m=k.tid,q=['<li id="'+m+'"',' style="left: '+h+'px;"',' class="{css-class}">',
'<div class="tl-type" style="z-index: '+f++ +'">',"{title} {key} </div>",'<div class="tl-selector" style="z-index: '+f++ +'">',"{selector}</div></li>"].join(""),r="click"==k.type||"keydown"==k.type||"keyup"==k.type||"keypress"==k.type?"red":-1<k.type.indexOf("DOM")?"blue":-1<k.type.indexOf("select")?"green":"default",q=q.replace(/{title}/igm,k.type).replace(/{selector}/igm,k.selector).replace(/{key}/igm,k.raw.key||"").replace(/{css-class}/igm,r),k={id:m,time:k.time,type:k.type,lastTimeLine:h};g.push(k);
n+=q}c.innerHTML=n;for(p in g)g.hasOwnProperty(p)&&(k=g[p],b=k.type,f=k.id,n=k.time,h=parseInt(100*(n/e)),h=parseInt(h*d/100),q=c.querySelector("#"+f),l&&(h>l-10&&h<l+10)&&(h=q.previousSibling,l=window.getComputedStyle(q),h=window.getComputedStyle(h),l=Math.abs(Math.round(100*parseFloat(l.top.replace("px",""))/100)),h=Math.abs(Math.round(100*parseFloat(h.top.replace("px",""))/100)),m=0,"click"==b||"keydown"==b||"keyup"==b||"keypress"==b||-1<b.indexOf("DOM")||-1<b.indexOf("select")?(h==l&&(m=l+8),
h>l&&(m=h-l+4),h<l&&(m=l-h+4),m=-m):(h==l&&(m=l+18),h>l&&(m=h-l+38),h<l&&(m=l-h+38),m-=70),m+="px",q.style.cssText+="top: "+m+";"),q.addEventListener("click",function(a,b,c,d){b=this.recordedEvents.filter(function(b){return b.tid==a})[0];console.log(b)}.bind(a,f,b,n)),l=k.lastTimeLine)};
Controls.prototype.player=function(){var a=this,b=a.traquer,c=b.recordedEvents;document.querySelector("ol.timeline-container");var d=document.querySelector(".timeline-track"),e=document.querySelector(".player");e||(e=document.createElement("div"),e.className="player",e.title="Replay",document.body.appendChild(e),e.innerHTML='<div class="play"></div>',b.playerTarget=e,e.addEventListener("stop",function(a){e.className="player"}),e.addEventListener("click",function(a,b){this.isPlaying?(this.stop(),e.className=
"player"):(e.className+=" playing",this.play(a))}.bind(b,c)));this.reset();d||(d=document.createElement("div"),d.className="timeline-track",document.body.appendChild(d),d.innerHTML='<div class="current-event"></div>',b.trackTarget=d,d.addEventListener("move",function(b){var c=b.detail.eventInfo,d=b.detail.last,e=c.time,p=a.tlcWidth,k=document.querySelector(".current-event"),d=parseInt(100*(e/d)),p=parseInt(d*p/100)+152;b.target.style.cssText="left: "+p+"px;";k.innerHTML=a.previousTime>e-2&&a.previousTime<
e+2?k.innerHTML+(c.type+"("+e+") <br />"):c.type+"("+e+") <br />";a.previousTime=e}))};
Controls.prototype.reset=function(){var a=this.traquer,b=a.recordedEvents,c=document.querySelector(".reset");c||(c=document.createElement("div"),c.className="reset",c.title="Reset",document.body.appendChild(c),c.innerHTML='<div class="play"></div>',c.addEventListener("click",function(a,b){var f=document.querySelector("ol.timeline-container"),g=document.querySelector(".timeline-track");document.querySelector(".current-event");var n=document.querySelector(".player");this.recordedEvents=[];document.body.removeChild(n);
document.body.removeChild(c);document.body.removeChild(f);document.body.removeChild(g)}.bind(a,b)))};"use strict";var EventBase=function(a){if(!(this instanceof EventBase))return new EventBase;if(!(a&&a instanceof Traquer))throw Error("Can't instantiate EventBase without Traquer instance!");this.traquer=a};
EventBase.prototype={getScrollTarget:function(a){for(;a!=document.body;){a=a.parentNode;var b=window.getComputedStyle(a);if(b&&"auto"==b["overflow-y"]&&a.scrollHeight>a.clientHeight)break}return a},shallowCopy:function(a,b){for(var c in b)try{a[c]=b[c]}catch(d){}return a},mouseEvents:function(a,b){var c=new MouseEvent(a.type,a.raw),c=this.shallowCopy(c,a.raw);this.traquer.toggleStopPropagation(a,c);b.dispatchEvent(c)},wheelEvents:function(a,b){b=this.getScrollTarget(b);var c=new WheelEvent("wheel",
a.raw),c=this.shallowCopy(c,a.raw);b.scrollLeft+=c.deltaX;b.scrollTop+=c.deltaY;b.dispatchEvent(c)},focusEvents:function(a,b){var c=-1<a.type.indexOf("FocusIn")?"focus":"blur";if(-1<a.type.indexOf("FocusIn")||-1<a.type.indexOf("FocusOut"))var d=setTimeout(function(){b.dispatchEvent(new FocusEvent(a.type,b));clearTimeout(d)},1);"focusin"!=a.type&&"DOMFocusIn"!=a.type||b.focus();"focusout"!=a.type&&"DOMFocusOut"!=a.type||b.blur();b.dispatchEvent(new FocusEvent(c,b))},inputEvents:function(a,b){var c=
new ("undefined"!=typeof InputEvent?InputEvent:Event)(a.type,a.raw),c=this.shallowCopy(c,a.raw);document.activeElement!=b&&(b=document.activeElement);b.value=void 0!=a.value?a.value:"";b.dispatchEvent(c)},keyEvents:function(a,b){var c=new KeyboardEvent(a.type,a.raw),c=this.shallowCopy(c,a.raw);document.activeElement!=b&&(b=document.activeElement);if(b.contentEditable&&"keypress"==a.type&&9!=a.raw.which){var d="";13==a.raw.which?(b.style.whiteSpace="pre",d="\r\r\n"):d=String.fromCharCode(a.raw.which);
b.textContent+=d}b.dispatchEvent(c)},UIEvents:function(a,b){var c=new UIEvent(a.type,a.raw);b.dispatchEvent(c)},selectionEvents:function(a,b){this.UIEvents(a,b)},event:function(a,b){var c=new Event(a.type,a.raw);b.dispatchEvent(c)}};"use strict";var Lzw=function(){if(!(this instanceof Lzw))return new Lzw};
Lzw.prototype.getHumanReadableLength=function(a){a=this.getByteLength(a);return 1073741824<a?Math.round(100*a/1073741824)/100+" GB":1048576<a?Math.round(100*a/1048576)/100+" MB":Math.round(100*a/1024)/100+" KB"};Lzw.prototype.getByteLength=function(a){for(var b=0,c=0;c<a.length;c++){var d=a.charCodeAt(c);127>=d?b+=1:2047>=d?b+=2:55296<=d&&57343>=d?(b+=4,c++):b=65535>d?b+3:b+4}return b};
Lzw.prototype.encode=function(a){a=JSON.stringify(a);var b={};a=(a+"").split("");for(var c=[],d,e=a[0],f=256,g=1;g<a.length;g++)d=a[g],null!=b[e+d]?e+=d:(c.push(1<e.length?b[e]:e.charCodeAt(0)),b[e+d]=f,f++,e=d);c.push(1<e.length?b[e]:e.charCodeAt(0));for(g=0;g<c.length;g++)c[g]=String.fromCharCode(c[g]);return c.join("")};
Lzw.prototype.decode=function(a){var b={};a=(a+"").split("");for(var c=a[0],d=c,e=[c],f=256,g,n=1;n<a.length;n++)g=a[n].charCodeAt(0),g=256>g?a[n]:b[g]?b[g]:d+c,e.push(g),c=g.charAt(0),b[f]=d+c,f++,d=g;e=e.join("");return e=JSON.parse(e)};"use strict";
var Traquer=function(){if(!(this instanceof Traquer))return new Traquer;this.index=0;this.logging=!1;this.recordedEvents=[];this.previousElement=null;this.eventNames="mousemove mouseenter mouseleave mouseover mousedown mouseup mouseout click scroll contextmenu wheel focus focusin focusout change input textinput keypress keydown keyup DOMFocusIn DOMFocusOut selectstart selectionchange select DOMActivate".split(" ");var a=document.createElement("div");a.className="traquer-base";document.body.appendChild(a);
window.onerror=function(b,c,d){var e=new Event("terror");e.details=[b,c,d];a.dispatchEvent(e)};a.addEventListener("terror",function(a){console.log("[e] some error");console.log(a)})};
Traquer.prototype={getId:function(){var a=this.recordedEvents;if(a&&a.length){var b="e_"+Math.random().toString(36).substring(3).substr(0,8),c=a.filter(function(a){if(a.tid==b)return c});if(c.length)this.getId();else return b}},isEventObservable:function(a){return a&&a.type?-1<this.eventNames.indexOf(a.type):!1},start:function(a){var b=this;b.isRecording=!0;b.recordingStartTime=(new Date).getTime();b.recordedEvents=[];b.mousePosition={x:0,y:0};var c=b.eventNames||[];b.processEventBinded=b.processEvent.bind(b);
c.forEach(function(a){document.body.addEventListener(a,b.processEventBinded,!1)});document.addEventListener("mousemove",function(a){b.mousePosition.x=a.clientX;b.mousePosition.y=a.clientY});a&&(this.logging=!0)},stop:function(){var a=this,b=a.eventNames||[];a.processEventBinded&&b.forEach(function(b){document.body.removeEventListener(b,a.processEventBinded,!1)});a.isRecording=!1;a.playerTarget&&(b=new Event("stop"),a.playerTarget.dispatchEvent(b));return this.recordedEvents},copyEventObject:function(a){var b=
{},c;for(c in a){var d=typeof a[c];"function"!=d&&"object"!=d&&(b[c]=a[c])}return b},processEvent:function(a){"mousedown"==a.type&&(this.isMouseDown=!0);if(this.isEventObservable(a)||this.isMouseDown){var b={tid:this.getId(),index:this.index,x:this.mousePosition.x,y:this.mousePosition.y,time:(new Date).getTime()-this.recordingStartTime,raw:this.copyEventObject(a),type:a.type,id:a.target.id,targetType:a.target.tagName?a.target.tagName.toLowerCase():null,value:a.target.value||a.target.text,attrs:this.getAttributes(a.target),
classList:this.getClassess(a.target)};"traquer-recorder"!=b.id&&(b.selector=this.createSelector.call(b,this),document.querySelectorAll(b.selector)&&(delete b.classList,delete b.attrs,this.recordedEvents.push(b),this.index++,this.logging&&console.log(b)))}"mouseup"==a.type&&(this.isMouseDown=!1)},eventsScheduler:function(){var a=this;if(a.eventsInfo&&a.eventsEmitted<a.eventsInfo.length)var b=a.eventsInfo[this.eventsEmitted],c=a.eventsInfo[this.eventsEmitted-1],d=setTimeout(function(){a.eventEmitter(b);
a.eventsEmitted++;a.eventsScheduler();clearTimeout(d)},c?b.time-c.time:b.time);else a.isPlaying=!1,a.removeFakeCursor()},play:function(a){if(!this.isPlaying){var b=this.getSimilarity(a);50>b&&console.warn("[w] Current scenario is less than 50% similar to page you`re testing ("+b+")");this.isPlaying=!0;this.createFakeCursor();this.eventsEmitted=0;this.eventsInfo=a;this.eventsScheduler()}},eventEmitter:function(a){if(a){var b=document.querySelector(a.selector),c=b?b:document.elementFromPoint(a.x,a.y),
d=this.getFakeCursor(),e=new EventBase(this);d.style.top=a.y+"px";d.style.left=a.x+"px";b||console.warn("[f] Cant find element by current selector, probably not there.",a.selector);if(this.previousElement){var b=this.matchChild(this.previousElement,c),d=this.getOffset(this.previousElement),f=this.getOffset(c);if(this.pointRectangleIntersection(f,{x1:d.x,x2:d.x+d.w,y1:d.y,y2:d.y+d.h})||b)a.stopPropagationFlag=!0;this.previousElement=null}else this.previousElement=c.parentElement;switch(a.type){case "mousemove":case "mouseenter":case "mouseleave":case "mouseover":case "mousedown":case "mouseup":case "mouseout":case "click":case "dblclick":case "contextmenu":e.mouseEvents(a,
c);break;case "wheel":e.wheelEvents(a,c);break;case "DOMFocusIn":case "DOMFocusOut":case "focusin":case "focus":case "focusout":case "blur":e.focusEvents(a,c);break;case "beforeinput":case "input":case "textinput":e.inputEvents(a,c);break;case "keypress":case "keydown":case "keyup":case "nothing":e.keyEvents(a,c);break;case "change":e.event(a,c);break;case "selectstart":case "selectionchange":e.focusEvents(a,c);break;case "scroll":case "select":case "DOMMouseScroll":case "DOMActivate":case "DOMSubtreeModified":case "DOMCharacterDataModified":e.UIEvents(a,
c)}this.trackTarget&&(c=new CustomEvent("move",{detail:{eventInfo:a,last:this.recordedEvents[this.recordedEvents.length-1].time}}),this.trackTarget.dispatchEvent(c))}this.recordedEvents.indexOf(a)==this.recordedEvents.length-1&&this.stop()},getFakeCursor:function(){return this.fakeCursor||this.createFakeCursor()},createFakeCursor:function(){this.fakeCursor=document.createElement("div");this.fakeCursor.style.height="10px";this.fakeCursor.style.width="10px";this.fakeCursor.style.background="red";this.fakeCursor.style.opacity=
"0.5";this.fakeCursor.style.display="block";this.fakeCursor.style.position="fixed";this.fakeCursor.style.borderRadius="10px";this.fakeCursor.style.zIndex="2147483647";document.body.appendChild(this.fakeCursor)},removeFakeCursor:function(){this.fakeCursor&&(document.body.removeChild(this.fakeCursor),delete this.fakeCursor)},toggleStopPropagation:function(a,b){var c=["mouseover","mouseenter","mouseleave","mouseout"];a.stopPropagationFlag&&-1<c.indexOf(a.type)&&b.stopPropagation()},getAttributes:function(a){var b=
[],c;for(c in a.attributes)if(a.attributes.hasOwnProperty(c)&&"style"!==a.attributes[c].name&&a.attributes[c].value){var d=a.attributes[c].value.match(/<.*?[\s\S]*?>[\s\S]*?<\/.*>/g),e=a.attributes[c].value.match(/(http:).*/g),f=a.attributes[c].name.match(/data-.*/g);"id"!=a.attributes[c].name&&(null==d&&null==e&&null==f)&&b.push(a.attributes[c].name+'="'+a.attributes[c].value+'"')}return b},getClassess:function(a){var b=[],c;for(c in a.classList)a.classList.hasOwnProperty(c)&&b.push(a.classList[c]);
return b},getSelector:function(a,b,c,d){var e="";if(0<a.length)for(var f in a)if(a.hasOwnProperty(f))if("value"===a[f])e+="["+a[f]+'="'+c+'"]';else if(void 0!==a[f]){var g=a[f].match(/class/g)||a[f].match(/selected/g)||a[f].match(/over/g)||a[f].match(/dirty/g)||a[f].match(/selectable/g)||a[f].match(/href/g)||a[f].match(/valign/g)||a[f].match(/role/g)||a[f].match(/tabindex/g);g||(e+="["+a[f]+"]")}if(0<b.length)for(f in b)b.hasOwnProperty(f)&&((g=b[f].match(/selected/g)||b[f].match(/over/g)||b[f].match(/dirty/g)||
b[f].match(/selectable/g)||b[f].match(/focused/g)||b[f].match(/focus/g))||(e+="."+b[f]));d&&(e+="#"+d);return e},createSelector:function(a){var b=this.targetType+a.getSelector(this.attrs,this.classList,this.value,this.id),c=document.querySelector(b),d=document.querySelectorAll(b),e;if(1<d.length)for(var f in d)if(d.hasOwnProperty(f)){var g=d[f];g.getBoundingClientRect();a.getIntersection(g,{height:10,left:a.mousePosition.x,top:a.mousePosition.y,width:10})&&(e=g==c?g.parentElement:g)}e&&e!=c&&(c=a.getAttributes(e),
d=a.getClassess(e),c.length&&d.length&&(b=a.getSelector(c,d,e.value,e.id)+" > "+b));return b},getIntersection:function(a,b){var c=a.getBoundingClientRect(),d=b.getBoundingClientRect?b.getBoundingClientRect():b,e=!1;c.left<=d.left+d.width&&d.left<=c.left+c.width&&(c.top<=d.top+d.height&&d.top<=c.top+c.height)&&(e=!0);return e},getOffset:function(a){a=a.getBoundingClientRect();return{x:a.left,y:a.top,w:a.width,h:a.height}},pointRectangleIntersection:function(a,b){return a.x>b.x1&&a.x<b.x2&&a.y>b.y1&&
a.y<b.y2},matchChild:function(a,b){var c;if(a&&a.childNodes)for(c in a.childNodes)if(a.childNodes.hasOwnProperty(c)){var d=a.childNodes[c];if(d==b)return!0;this.matchChild(d,b)}return!1},getSimilarity:function(a){var b=0,c=0,d;for(d in a)a.hasOwnProperty(d)&&(c=document.querySelector(a[d].selector))&&"hidden"!=window.getComputedStyle(c).visibility&&b++;return c=100*(b/a.length)}};
